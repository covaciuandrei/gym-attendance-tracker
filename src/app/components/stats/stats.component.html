<div class="stats-container">
  <header class="stats-header">
    <button class="nav-btn" (click)="previousPeriod()">
      <span>‚Äπ</span>
    </button>
    <h2 class="title">{{ getDisplayTitle() | translate }}</h2>
    <button class="nav-btn" (click)="nextPeriod()">
      <span>‚Ä∫</span>
    </button>
  </header>

  <!-- View Toggle -->
  <div class="view-toggle">
    <button class="toggle-btn" [class.active]="viewMode === 'attendances'" (click)="toggleView('attendances')">
      {{ 'STATS.ATTENDANCES' | translate }}
    </button>
    <button class="toggle-btn" [class.active]="viewMode === 'workouts'" (click)="toggleView('workouts')">
      {{ 'STATS.WORKOUTS' | translate }}
    </button>
    <button class="toggle-btn" [class.active]="viewMode === 'duration'" (click)="toggleView('duration')">
      {{ 'STATS.DURATION' | translate }}
    </button>
    <button class="toggle-btn" [class.active]="viewMode === 'health'" (click)="toggleView('health')">
      Health
    </button>
  </div>

  <div class="stats-content" *ngIf="!isLoading">

    <!-- Health Stats -->
    <div class="health-view" *ngIf="viewMode === 'health'">

      <!-- Summary Cards -->
      <div class="summary-cards">
        <div class="stat-card health-primary">
          <div class="stat-icon">üíä</div>
          <div class="stat-content">
            <span class="stat-value" *ngIf="topMonthlySupp">{{ topMonthlySupp.name }}</span>
            <span class="stat-value" *ngIf="!topMonthlySupp">-</span>
            <span class="stat-label">Top This Month</span>
            <span class="stat-sub" *ngIf="topMonthlySupp">{{ topMonthlySupp.count }}x ({{ topMonthlySupp.avgPerDay |
              number:'1.1-1' }}/day)</span>
          </div>
        </div>
        <div class="stat-card health-secondary">
          <div class="stat-icon">üìÖ</div>
          <div class="stat-content">
            <span class="stat-value" *ngIf="topYearlySupp">{{ topYearlySupp.name }}</span>
            <span class="stat-value" *ngIf="!topYearlySupp">-</span>
            <span class="stat-label">Top This Year</span>
            <span class="stat-sub" *ngIf="topYearlySupp">{{ topYearlySupp.count }}x ({{ topYearlySupp.avgPerDay |
              number:'1.1-1' }}/day)</span>
          </div>
        </div>
        <div class="stat-card health-tertiary">
          <div class="stat-icon">üéØ</div>
          <div class="stat-content">
            <span class="stat-value">{{ consistencyPercentage }}%</span>
            <span class="stat-label">Consistency</span>
          </div>
        </div>
      </div>


      <!-- HEALTH -->
      <!-- Monthly Section with Picker -->
      <div class="chart-container monthly-section">
        <div class="month-picker">
          <button class="nav-btn-small" (click)="prevHealthMonth()">‚Äπ</button>
          <h3 class="month-title">{{ 'MONTHS.' + monthNames[selectedHealthMonth] | translate }} {{ currentYear }}</h3>
          <button class="nav-btn-small" (click)="nextHealthMonth()">‚Ä∫</button>
        </div>

        <div class="month-total">
          <span class="total-value">{{ monthlyServingsCount }}</span>
          <span class="total-label">servings this month</span>
        </div>

        <div class="chart workout-type-chart" *ngIf="monthlySupplementStats.length > 0">
          <div class="chart-bar" *ngFor="let stat of monthlySupplementStats">
            <div class="bar-container">
              <div class="bar has-value" [style.height.%]="(stat.count / getMaxSupplementCount()) * 100"
                [style.background]="stat.color">
                <span class="bar-value">{{ stat.count }}</span>
              </div>
            </div>
            <span class="bar-label icon-label" style="font-size: 0.5em;">üíä</span>
            <span class="bar-label name-label" [title]="stat.name">{{ stat.name }}</span>
          </div>
        </div>

        <div class="no-data" *ngIf="monthlySupplementStats.length === 0">
          <p>No supplements logged this month</p>
          <p class="hint">Start tracking your supplements in the Health tab</p>
        </div>
      </div>

      <!-- Yearly Summary -->
      <div class="chart-container yearly-section">
        <h3 class="chart-title">{{ currentYear }} Summary</h3>

        <!-- Most Taken Product -->
        <div class="top-item-card" *ngIf="mostTakenProduct">
          <span class="top-item-icon">üèÜ</span>
          <div class="top-item-info">
            <span class="top-item-name">{{ mostTakenProduct.name }}</span>
            <span class="top-item-label">Most Taken Supplement</span>
          </div>
          <span class="top-item-badge">{{ mostTakenProduct.count }}x</span>
        </div>

        <!-- Top Nutrients Section -->
        <h4 class="section-subtitle" *ngIf="topNutrients.length > 0">Top Nutrients</h4>
        <div class="nutrient-list" *ngIf="topNutrients.length > 0">
          <div class="nutrient-item" *ngFor="let nut of topNutrients; let i = index">
            <span class="nutrient-rank">{{ i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : 'üíé' }}</span>
            <span class="nutrient-name">{{ nut.name }}</span>
            <span class="nutrient-amount">{{ nut.amount | number:'1.0-1' }}{{ nut.unit }}</span>
          </div>
        </div>

        <div class="no-data" *ngIf="topNutrients.length === 0 && !mostTakenProduct">
          <p>No nutrient data available yet.</p>
        </div>
      </div>

    </div>
    <!-- Attendances View -->
    <div class="attendances-view" *ngIf="viewMode === 'attendances'">
      <!-- Summary Cards -->
      <div class="summary-cards">
        <div class="stat-card primary">
          <div class="stat-icon">üìÖ</div>
          <div class="stat-content">
            <span class="stat-value">{{ monthlyCount }}</span>
            <span class="stat-label">{{ 'STATS.THIS_MONTH' | translate }}</span>
          </div>
        </div>
        <div class="stat-card secondary">
          <div class="stat-icon">üéØ</div>
          <div class="stat-content">
            <span class="stat-value">{{ yearlyCount }}</span>
            <span class="stat-label">{{ 'STATS.THIS_YEAR' | translate }}</span>
          </div>
        </div>
        <div class="stat-card tertiary">
          <div class="stat-icon">üèÜ</div>
          <div class="stat-content">
            <span class="stat-value">{{ totalCount }}</span>
            <span class="stat-label">{{ 'STATS.ALL_TIME' | translate }}</span>
          </div>
        </div>
      </div>

      <!-- Yearly Chart -->
      <div class="chart-container">
        <h3 class="chart-title">{{ 'STATS.MONTHLY_BREAKDOWN' | translate }}</h3>
        <div class="chart">
          <div class="chart-bar" *ngFor="let data of monthlyData">
            <div class="bar-container">
              <div class="bar" [style.height.%]="(data.count / getMaxCount()) * 100" [class.has-value]="data.count > 0">
                <span class="bar-value" *ngIf="data.count > 0">{{ data.count }}</span>
              </div>
            </div>
            <span class="bar-label">{{ 'MONTHS_SHORT.' + data.month | translate }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Workouts View -->
    <div class="workouts-view" *ngIf="viewMode === 'workouts'">

      <!-- Yearly Total Banner -->
      <div class="untracked-badge">
        <span class="untracked-icon">üèÜ</span>
        <span class="untracked-text">{{ 'STATS.YEARLY_SUMMARY' | translate:{ year: currentYear, count:
          getTotalWorkouts()
          } }}</span>
      </div>


      <!--WORKOUTS -->
      <!-- Monthly Workout Stats with Picker -->
      <div class="chart-container monthly-section">
        <div class="month-picker">
          <button class="nav-btn-small" (click)="prevWorkoutMonth()">‚Äπ</button>
          <h3 class="month-title">{{ 'MONTHS.' + monthNames[selectedWorkoutMonth] | translate }} {{ currentYear }}</h3>
          <button class="nav-btn-small" (click)="nextWorkoutMonth()">‚Ä∫</button>
        </div>

        <div class="month-total">
          <span class="total-value">{{ getMonthlyWorkoutTotal() }}</span>
          <span class="total-label">{{ 'STATS.WORKOUTS_THIS_MONTH' | translate }}</span>
        </div>

        <div class="chart workout-type-chart" *ngIf="monthlyWorkoutStats.length > 0">
          <div class="chart-bar" *ngFor="let stat of monthlyWorkoutStats">
            <div class="bar-container">
              <div class="bar has-value" [style.height.%]="(stat.count / getMaxMonthlyWorkoutCount()) * 100"
                [style.background]="stat.color">
                <span class="bar-value">{{ stat.count }}</span>
              </div>
            </div>
            <span class="bar-label icon-label">{{ stat.icon }}</span>
            <span class="bar-label name-label" [title]="stat.name">{{ stat.name }}</span>
          </div>
        </div>

        <div class="no-data" *ngIf="monthlyWorkoutStats.length === 0">
          <p>{{ 'STATS.NO_WORKOUTS' | translate }} {{ 'MONTHS.' + monthNames[selectedWorkoutMonth] | translate }}</p>
        </div>
      </div>

      <!-- Yearly Summary -->
      <div class="chart-container yearly-section">
        <h3 class="chart-title">{{ 'STATS.YEARLY_SUMMARY' | translate:{ year: currentYear, count: getTotalWorkouts() }
          }}
        </h3>

        <div class="workout-type-list compact" *ngIf="workoutTypeStats.length > 0">
          <div class="workout-type-item" *ngFor="let stat of workoutTypeStats">
            <div class="type-info">
              <span class="type-icon">{{ stat.icon }}</span>
              <span class="type-name">{{ stat.name }}</span>
            </div>
            <div class="type-bar-container">
              <div class="type-bar" [style.width.%]="(stat.count / getMaxWorkoutCount()) * 100"
                [style.background]="stat.color">
              </div>
            </div>
            <span class="type-count">{{ stat.count }}</span>
          </div>
        </div>

        <div class="no-data" *ngIf="workoutTypeStats.length === 0">
          <p>{{ 'STATS.NO_DATA' | translate }} {{ currentYear }}</p>
          <p class="hint">{{ 'STATS.START_TRACKING' | translate }}</p>
        </div>
      </div>

    </div>

    <!-- Duration View -->
    <div class="duration-view" *ngIf="viewMode === 'duration'">

      <!-- Summary Cards -->
      <div class="summary-cards duration-cards">
        <div class="stat-card duration-primary">
          <div class="stat-icon">‚è±Ô∏è</div>
          <div class="stat-content">
            <span class="stat-value">{{ formatDuration(monthlyAvgDuration) }}</span>
            <span class="stat-label">{{ 'STATS.AVG_THIS_MONTH' | translate }}</span>
          </div>
        </div>
        <div class="stat-card duration-secondary">
          <div class="stat-icon">üìä</div>
          <div class="stat-content">
            <span class="stat-value">{{ formatDuration(yearlyAvgDuration) }}</span>
            <span class="stat-label">{{ 'STATS.AVG_THIS_YEAR' | translate }}</span>
          </div>
        </div>
      </div>

      <!-- Untracked Workouts Badge -->
      <div class="untracked-badge" *ngIf="untrackedWorkoutsMonth > 0">
        <span class="untracked-icon">üìù</span>
        <span class="untracked-text">{{ 'STATS.UNTRACKED_WORKOUTS' | translate }}: {{ untrackedWorkoutsMonth }}</span>
      </div>

      <!-- Monthly Duration Stats with Picker -->
      <div class="chart-container monthly-section">
        <div class="month-picker">
          <button class="nav-btn-small" (click)="prevWorkoutMonth()">‚Äπ</button>
          <h3 class="month-title">{{ 'MONTHS.' + monthNames[selectedWorkoutMonth] | translate }} {{ currentYear }}</h3>
          <button class="nav-btn-small" (click)="nextWorkoutMonth()">‚Ä∫</button>
        </div>

        <div class="month-total">
          <span class="total-value">{{ formatDuration(monthlyAvgDuration) }}</span>
          <span class="total-label">avg duration this month</span>
        </div>

        <div class="chart workout-type-chart" *ngIf="monthlyDurationStats.length > 0">
          <div class="chart-bar" *ngFor="let stat of monthlyDurationStats">
            <div class="bar-container">
              <div class="bar has-value" [style.height.%]="(stat.avgMinutes / getMaxMonthlyDurationMinutes()) * 100"
                [style.background]="stat.color">
                <span class="bar-value">{{ formatDuration(stat.avgMinutes) }}</span>
              </div>
            </div>
            <span class="bar-label icon-label">{{ stat.icon }}</span>
            <span class="bar-label name-label" [title]="stat.name">{{ stat.name }}</span>
          </div>
        </div>

        <div class="no-data" *ngIf="monthlyDurationStats.length === 0">
          <p>{{ 'STATS.NO_DURATION_DATA' | translate }} {{ 'MONTHS.' + monthNames[selectedWorkoutMonth] | translate }}
          </p>
          <p class="hint">{{ 'STATS.START_TRACKING_DURATION' | translate }}</p>
        </div>
      </div>

      <!-- Yearly Duration Summary -->
      <div class="chart-container yearly-section">
        <h3 class="chart-title">{{ 'STATS.YEARLY_DURATION_SUMMARY' | translate:{ year: currentYear } }}</h3>

        <div class="workout-type-list compact" *ngIf="workoutTypeDurationStats.length > 0">
          <div class="workout-type-item" *ngFor="let stat of workoutTypeDurationStats">
            <div class="type-info">
              <span class="type-icon">{{ stat.icon }}</span>
              <span class="type-name">{{ stat.name }}</span>
            </div>
            <div class="type-bar-container">
              <div class="type-bar" [style.width.%]="(stat.avgMinutes / getMaxDurationMinutes()) * 100"
                [style.background]="stat.color">
              </div>
            </div>
            <span class="type-count duration-value">{{ formatDuration(stat.avgMinutes) }}</span>
          </div>
        </div>

        <div class="no-data" *ngIf="workoutTypeDurationStats.length === 0">
          <p>{{ 'STATS.NO_DURATION_DATA' | translate }} {{ currentYear }}</p>
          <p class="hint">{{ 'STATS.START_TRACKING_DURATION' | translate }}</p>
        </div>
      </div>


    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" *ngIf="isLoading">
      <div class="spinner"></div>
    </div>
  </div>